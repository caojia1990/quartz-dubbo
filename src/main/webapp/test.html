<html>
<head>
<meta charset="utf-8">
<title>Quartz-Dubbo</title>

<!-- Bootstrap -->
<link rel="stylesheet" href="js/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="js/plugin/bootstrap-table/bootstrap-table.css">
<link href="dashboard.css" rel="stylesheet">

<script src="js/jquery/jquery.min.js"></script>
<script src="js/bootstrap/js/bootstrap.min.js"></script>
<script src="js/plugin/bootstrap-table/bootstrap-table.js"></script>
<!-- put your locale files after bootstrap-table.js -->
<script src="js/plugin/bootstrap-table/locale/bootstrap-table-zh-CN.js"></script>

<script type="text/javascript">
    function operationFormatter(value,row,index) {
        var html = '<button type="button" id="exe'+index+'" class="btn btn-default btn-sm" title="立即执行">'
                     + '<i class="glyphicon glyphicon-flash"></i>'
                 + '</button>'
                 + '<button type="button" id="play'+index+'" class="btn btn-default btn-sm" title="启动任务">'
                     + '<i class="glyphicon glyphicon-play"></i>'
                 + '</button>'
                 + '<button type="button" id="pause'+index+'" class="btn btn-default btn-sm" title="暂停任务">'
                     + '<i class="glyphicon glyphicon-pause"></i>'
                 + '</button>'
                 + '<button type="button" id="time'+index+'" class="btn btn-default btn-sm" title="添加触发器">'
                     + '<i class="glyphicon glyphicon-time"></i>'
                 + '</button>'
                 + '<button type="button" id="cog'+index+'" class="btn btn-default btn-sm" title="设置">'
                     + '<i class="glyphicon glyphicon-cog"></i>'
                 + '</button>'
                 + '<button type="button" id="trash'+index+'" class="btn btn-default btn-sm" title="删除任务">'
                     + '<i class="glyphicon glyphicon-trash"></i>'
                 + '</button>';
        $("#table").off("click","#exe"+index);
        $("#table").on("click","#exe"+index,row,function(event){
            execute(row);
        });
        $("#table").off("click","#play"+index);
        $("#table").on("click","#play"+index,row,function(event){
            play(row);
        });
        $("#table").off("click","#pause"+index);
        $("#table").on("click","#pause"+index,row,function(event){
            pause(row);
        });
        $("#table").off("click","#cog"+index);
        $("#table").on("click","#cog"+index,row,function(event){
            config(row);
        });
        $("#table").off("click","#trash"+index);
        $("#table").on("click","#trash"+index,row,function(event){
            trash(row);
        });
        $("#table").off("click","#time"+index);
        $("#table").on("click","#time"+index,row,function(event){
            time(row);
        });
        return html;
    }
    /* 触发器栏操作按钮 */
    function triggerOptFormatter(value,row,index){
    	var btindex = index+""+row.index;
    	var html = '<button type="button" id="triggeer-cog'+btindex+'" class="btn btn-default btn-sm" title="修改">'
			        + '<i class="glyphicon glyphicon-cog"></i>'
		         + '</button>'
		         + '<button type="button" id="triggeer-trash'+btindex+'" class="btn btn-default btn-sm" title="删除触发器">'
		            + '<i class="glyphicon glyphicon-trash"></i>'
		         + '</button>';
    	$("#table").off("click","#triggeer-cog"+btindex);
        $("#table").on("click","#triggeer-cog"+btindex,row,function(event){
        	triggeerCog(row);
        });
        $("#table").off("click","#triggeer-trash"+btindex);
        $("#table").on("click","#triggeer-trash"+btindex,row,function(event){
        	triggeerTrash(row);
        });
        return html;
    }
    
    function detailFormatter(index, row,$detail) {
        /* var html = [];
        $.each(row, function (key, value) {
            html.push('<p><b>' + key + ':</b> ' + value + '</p>');
        });
        alert(html.join(''));
        return html.join(''); */
        
        var tableHtml = '<table id="sonTable">'
                           +'<thead>'
                            +'<tr>'
                               +'<th data-field="triggerName">触发器名</th>'
                               +'<th data-field="priority">优先级</th>'
                               +'<th data-field="cronExpression">cron表达式</th>'
                               +'<th data-field="description">描述</th>'
                               +'<th data-field="state">状态</th>'
                               +'<th data-field="previousFireTime">上次触发时间</th>'
                               +'<th data-field="nextFireTime">下次触发时间</th>'
                               +'<th data-field="operate" data-formatter="triggerOptFormatter">操作</th>'
                            +'</tr>'
                          +'</thead>'
                       +'</table>'
        
        var cur_table = $detail.html(tableHtml).find('table');
        /* 给子表row增加两个父表属性 */
        $.map(row.triggerBeans,function(item){
        	item.index = index;
            item.jobName = row.name;
            item.jobGroup = row.group;
            return item;
        })
        
        $(cur_table).bootstrapTable({
            data: row.triggerBeans
        })
    }
    
    /* 创建任务 */
    function savejob(){
        var parameter = {name: $("#name").val(),
                         group: $("#group").val(),
                         description: $("#description").val(),
                         jobData: {protocol: $("#protocol").val(),
                                   address: $("#address").val(),
                                   port: $("#port").val(),
                                   interfaceName: $("#interfaceName").val(),
                                   methodName: $("#methodName").val(),
                                   version: $("#version").val(),
                                   timeout: $("#timeout").val()
                                  }
                    };
        $.ajax({
            type: "POST",
            url: "addJob",
            contentType: "application/json;charset=UTF-8",
            data: JSON.stringify(parameter),
            success: function (date, status){
                $('#addModal').modal('hide')
                $("#table").bootstrapTable('refresh');
            }
        });
    }
    
    /* 添加触发器 */
    function addTrigger(){
        var parameter = {jobName: $("#job-name").val(),
                jobGroup: $("#job-group").val(),
                triggerName: $("#trigger-name").val(),
                priority: $("#trigger-priority").val(),
                cronExpression: $("#trigger-cronExpression").val(),
                description: $("#trigger-description").val()
           };
        $.ajax({
           type: "POST",
           url: "addTrigger",
           contentType: "application/json;charset=UTF-8",
           data: JSON.stringify(parameter),
           success: function (date, status){
               $('#triggerModal').modal('hide')
               $("#table").bootstrapTable('refresh');
           }
        });    
    }
    
    /* 修改触发器 */
    function editTrigger(){
        var parameter = {jobName: $("#edit-job-name").val(),
                jobGroup: $("#edit-job-group").val(),
                triggerName: $("#edit-trigger-name").val(),
                triggerGroup: $("#edit-trigger-group").val(),
                priority: $("#edit-trigger-priority").val(),
                cronExpression: $("#edit-trigger-cronExpression").val(),
                description: $("#edit-trigger-description").val()
           };
        $.ajax({
           type: "POST",
           url: "rescheduleJob",
           contentType: "application/json;charset=UTF-8",
           data: JSON.stringify(parameter),
           success: function (date, status){
               $('#editTriggerModal').modal('hide')
               $("#table").bootstrapTable('refresh');
           }
        });    
    }
    /* 修改任务 */
    function modifyJob(){
        var parameter = {name: $("#edit-name").val(),
                group: $("#edit-group").val(),
                description: $("#edit-description").val(),
                replace: true,
                jobData: {protocol: $("#edit-protocol").val(),
                          address: $("#edit-address").val(),
                          port: $("#edit-port").val(),
                          interfaceName: $("#edit-interfaceName").val(),
                          methodName: $("#edit-methodName").val(),
                          version: $("#edit-version").val(),
                          timeout: $("#edit-timeout").val()
                         }
           };
        $.ajax({
           type: "POST",
           url: "addJob",
           contentType: "application/json;charset=UTF-8",
           data: JSON.stringify(parameter),
           success: function (date, status){
               $('#editModal').modal('hide')
               $("#table").bootstrapTable('refresh');
           }
        });
    }
    /* 立即执行任务 */
    function execute(row){
        if(confirm("立即执行任务："+row.name+",确定吗？")){
            var parameter = {name: row.name,
                    group: row.group};
           $.ajax({
               type: "POST",
               url: "triggerJob",
               //contentType: "application/json;charset=UTF-8",
               data: parameter,
               success: function (date, status){
                   
               }
           });
        }

    }
    /* 恢复任务 */
    function play(row){
        if(confirm("恢复任务："+row.name+",确定吗？")){
            var parameter = {name: row.name,
                             group: row.group};
            $.ajax({
                type: "POST",
                url: "resumeJob",
                //contentType: "application/json;charset=UTF-8",
                data: parameter,
                success: function (date, status){
                    
                }
            });
        }
    }
    /* 暂停任务 */
    function pause(row){
        if(confirm("暂停任务："+row.name+",确定吗？")){
            var parameter = {name: row.name,
                             group: row.group};
            $.ajax({
                type: "POST",
                url: "pauseJob",
                //contentType: "application/json;charset=UTF-8",
                data: parameter,
                success: function (date, status){
                    
                }
            });
        }
    }
    /* 删除任务 */
    function trash(row){
        if(confirm("删除任务："+row.name+",确定吗？")){
            var parameter = {name: row.name,
                             group: row.group};
            $.ajax({
                type: "POST",
                url: "removeJob",
                //contentType: "application/json;charset=UTF-8",
                data: parameter,
                success: function (date, status){
                    $("#table").bootstrapTable('refresh');
                }
            });
        }
    }
    /* 修改任务模态框 */
    function config(row){
        $("#edit-name").val(row.name);
        $("#edit-group").val(row.group);
        $("#edit-description").val(row.description);
        if(row.jobData != null){
            $("#edit-address").val(row.jobData.address);
            $("#edit-protocol").val(row.jobData.protocol);
            $("#edit-port").val(row.jobData.port);
            $("#edit-interfaceName").val(row.jobData.interfaceName);
            $("#edit-methodName").val(row.jobData.methodName);
            $("#edit-version").val(row.jobData.version);
            $("#edit-timeout").val(row.jobData.timeout);
        }
        $("#editModal").modal('show');
    }
    
    function time(row){
        $("#job-name").val(row.name);
        $("#job-group").val(row.group);
        $("#triggerModal").modal('show');
    }
    
    /* 修改触发器模态框 */
    function triggeerCog(row){
    	$("#edit-job-name").val(row.jobName);
    	$("#edit-job-group").val(row.jobGroup);
    	$("#edit-trigger-name").val(row.triggerName);
    	$("#edit-trigger-group").val(row.triggerGroup);
    	$("#edit-trigger-cronExpression").val(row.cronExpression);
    	$("#edit-trigger-priority").val(row.priority);
    	$("#edit-trigger-description").val(row.description);
    	$("#editTriggerModal").modal('show');
    }
    
    /* 删除触发器 */
    function triggeerTrash(row){
    	if(confirm("删除触发器："+row.triggerName+",确定吗？")){
            var parameter = {triggerName: row.triggerName,
            		         triggerGroup: row.triggerGroup};
            $.ajax({
                type: "POST",
                url: "removeTrigger",
                //contentType: "application/json;charset=UTF-8",
                data: parameter,
                success: function (date, status){
                    $("#table").bootstrapTable('refresh');
                }
            });
        }
    }
    
    $(function(){
        $("#methodName").on("blur",function(){
        	var interfaceName = $("#interfaceName").val();
            var methodName = $("#methodName").val();
            var parameter = {interfaceName: $("#interfaceName").val(),
            		methodName: $("#methodName").val()};
		   $.ajax({
		       type: "POST",
		       url: "getParameter",
		       //contentType: "application/json;charset=UTF-8",
		       data: parameter,
		       success: function (date, status){
		           $("#parameter").val(JSON.stringify(date));
		       }
		   });
        })
    })
    
</script>
</head>
<body>

    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Project name</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="#">Dashboard</a></li>
            <li><a href="#">Settings</a></li>
            <li><a href="#">Profile</a></li>
            <li><a href="#">Help</a></li>
          </ul>
          <form class="navbar-form navbar-right">
            <input type="text" class="form-control" placeholder="Search...">
          </form>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <div class="col-sm-3 col-md-2 sidebar">
          <ul class="nav nav-sidebar">
            <li class="active"><a href="#">Overview <span class="sr-only">(current)</span></a></li>
            <li><a href="#">所有任务</a></li>
            <!-- <li><a href="#">Analytics</a></li>
            <li><a href="#">Export</a></li> -->
          </ul>
          <!-- <ul class="nav nav-sidebar">
            <li><a href="">Nav item</a></li>
            <li><a href="">Nav item again</a></li>
            <li><a href="">One more nav</a></li>
            <li><a href="">Another nav item</a></li>
            <li><a href="">More navigation</a></li>
          </ul>
          <ul class="nav nav-sidebar">
            <li><a href="">Nav item again</a></li>
            <li><a href="">One more nav</a></li>
            <li><a href="">Another nav item</a></li>
          </ul> -->
        </div>
        <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
        
        
          <div class="table-responsive">
            <div id="toolbar" class="btn-group">
                <button type="button" class="btn btn-default" data-toggle="modal" data-target="#addModal" title="创建任务">
                    <i class="glyphicon glyphicon-plus"></i>
                </button>
            </div>
            <table id="table"
               data-toggle="table" 
               data-toolbar="#toolbar"
               data-search="true"
               data-show-refresh="true"
               data-show-toggle="true"
               data-show-columns="true"
               data-show-export="true"
               data-detail-view="true"
               data-detail-formatter="detailFormatter"
               data-pagination="true"
               data-height="542"
               data-url="getAllJobs">
              <thead>
                <tr>
                    <th data-field="group">项目</th>
                    <th data-field="name">任务名</th>
                    <th data-field="description">描述</th>
                    <th data-field="jobData.interfaceName">接口名</th>
                    <th data-field="jobData.methodName">方法名</th>
                    <th data-field="jobData" data-formatter="operationFormatter">操作</th>
                </tr>
              </thead>
            </table>
          </div>
        </div>
      </div>
    </div>
    <!-- 创建任务 -->
    <div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <h4 class="modal-title" id="myModalLabel">创建任务</h4>
          </div>
          <div class="modal-body">
              <form class="form-horizontal" role="form">
                  <div class="form-group">
                    <label for="name" class="col-sm-2 control-label">任务名称</label>
                    <div class="col-sm-4">
                      <input type="text" class="form-control" id="name" placeholder="">
                    </div>
                    <label for="group" class="col-sm-2 control-label">项目名称</label>
                    <div class="col-sm-4">
                      <input type="text" class="form-control" id="group" placeholder="">
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="description" class="col-sm-2 control-label">功能描述</label>
                    <div class="col-sm-10">
                      <input type="text" class="form-control" id="description" placeholder="">
                    </div>
                  </div>
                  <hr>
                  <div class="form-group">
                    <label for="protocol" class="col-sm-2 control-label">调用方式</label>
                    <div class="col-sm-10">
                      <select class="form-control" id="protocol" >
                        <option value="zookeeper">zookeeper注册</option>
                        <option value="dubbo">dubbo直连</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="address" class="col-sm-2 control-label">服务注册ip</label>
                    <div class="col-sm-4">
                      <input type="text" class="form-control" id="address" placeholder="服务注册ip">
                    </div>
                    <label for="port" class="col-sm-2 control-label">端口</label>
                    <div class="col-sm-4">
                      <input type="text" class="form-control" id="port" placeholder="端口">
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="interfaceName" class="col-sm-2 control-label">接口全限定名</label>
                    <div class="col-sm-10">
                      <input type="text" class="form-control" id="interfaceName" placeholder="例：com.example.package.interface">
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="methodName" class="col-sm-2 control-label">方法名</label>
                    <div class="col-sm-10">
                      <input type="text" class="form-control" id="methodName" placeholder="例：sayhello">
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="parameter" class="col-sm-2 control-label">参数</label>
                    <div class="col-sm-10">
                      <textarea class="form-control" id="parameter" rows="3"></textarea>
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="version" class="col-sm-2 control-label">版本</label>
                    <div class="col-sm-4">
                      <input type="text" class="form-control" id="version" placeholder="">
                    </div>
                    <label for="timeout" class="col-sm-2 control-label">超时时间</label>
                    <div class="col-sm-4">
                      <input type="text" class="form-control" id="timeout" placeholder="单位：秒（默认30秒）">
                    </div>
                  </div>
                </form>
            ...
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" onclick="savejob()">Save</button>
          </div>
        </div>
      </div>
    </div>
    <!-- 修改任务 -->
    <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <h4 class="modal-title" id="myModalLabel">修改任务</h4>
          </div>
          <div class="modal-body">
              <form class="form-horizontal" role="form">
                  <div class="form-group">
                    <label for="edit-name" class="col-sm-2 control-label">任务名称</label>
                    <div class="col-sm-4">
                      <input type="text" class="form-control" id="edit-name" placeholder="" readonly>
                    </div>
                    <label for="edit-group" class="col-sm-2 control-label">项目名称</label>
                    <div class="col-sm-4">
                      <input type="text" class="form-control" id="edit-group" placeholder="" readonly>
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="edit-description" class="col-sm-2 control-label">功能描述</label>
                    <div class="col-sm-10">
                      <input type="text" class="form-control" id="edit-description" placeholder="">
                    </div>
                  </div>
                  <hr>
                  <div class="form-group">
                    <label for="edit-protocol" class="col-sm-2 control-label">调用方式</label>
                    <div class="col-sm-10">
                      <select class="form-control" id="edit-protocol" >
                        <option value="zookeeper">zookeeper注册</option>
                        <option value="dubbo">dubbo直连</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="edit-address" class="col-sm-2 control-label">服务注册ip</label>
                    <div class="col-sm-4">
                      <input type="text" class="form-control" id="edit-address" placeholder="服务注册ip">
                    </div>
                    <label for="edit-port" class="col-sm-2 control-label">端口</label>
                    <div class="col-sm-4">
                      <input type="text" class="form-control" id="edit-port" placeholder="端口">
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="edit-interfaceName" class="col-sm-2 control-label">接口全限定名</label>
                    <div class="col-sm-10">
                      <input type="text" class="form-control" id="edit-interfaceName" placeholder="例：com.example.package.interface">
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="edit-methodName" class="col-sm-2 control-label">方法名</label>
                    <div class="col-sm-10">
                      <input type="text" class="form-control" id="edit-methodName" placeholder="例：sayhello">
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="edit-version" class="col-sm-2 control-label">版本</label>
                    <div class="col-sm-4">
                      <input type="text" class="form-control" id="edit-version" placeholder="">
                    </div>
                    <label for="edit-timeout" class="col-sm-2 control-label">超时时间</label>
                    <div class="col-sm-4">
                      <input type="text" class="form-control" id="edit-timeout" placeholder="单位：秒（默认30秒）">
                    </div>
                  </div>
                </form>
            ...
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" onclick="modifyJob()">Save Change</button>
          </div>
        </div>
      </div>
    </div>
    <!-- 添加触发器 -->
    <div class="modal fade bs-example-modal-sm" id="triggerModal" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <h4 class="modal-title" id="mySmallModalLabel">添加触发器</h4>
          </div>
          <div class="modal-body">
              <form class="form-horizontal" role="form">
                  <div class="form-group">
                    <div class="col-sm-12">
                        <input type="hidden" class="form-control" id="job-name" >
                        <input type="hidden" class="form-control" id="job-group" >
                        <input type="text" class="form-control" id="trigger-name" placeholder="触发器名" >
                    </div>
                  </div>
                  <div class="form-group">
                    <div class="col-sm-12">
                      <input type="text" class="form-control" id="trigger-cronExpression" placeholder="cron表达式" >
                    </div>
                  </div>
                  <div class="form-group">
                    <div class="col-sm-12">
                      <input type="text" class="form-control" id="trigger-priority" placeholder="优先级" >
                    </div>
                  </div>
                  <div class="form-group">
                    <div class="col-sm-12">
                      <input type="text" class="form-control" id="trigger-description" placeholder="描述" >
                    </div>
                  </div>
              </form>
            ...
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" onclick="addTrigger()">Save</button>
          </div>
        </div>
      </div>
    </div>
    <!-- 修改触发器 -->
    <div class="modal fade bs-example-modal-sm" id="editTriggerModal" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <h4 class="modal-title" id="mySmallModalLabel">修改触发器</h4>
          </div>
          <div class="modal-body">
              <form class="form-horizontal" role="form">
                  <div class="form-group">
                    <div class="col-sm-12">
                        <input type="hidden" class="form-control" id="edit-job-name" >
                        <input type="hidden" class="form-control" id="edit-job-group" >
                        <input type="hidden" class="form-control" id="edit-trigger-group" >
                        <input type="text" class="form-control" id="edit-trigger-name" placeholder="触发器名" readonly >
                    </div>
                  </div>
                  <div class="form-group">
                    <div class="col-sm-12">
                      <input type="text" class="form-control" id="edit-trigger-cronExpression" placeholder="cron表达式" >
                    </div>
                  </div>
                  <div class="form-group">
                    <div class="col-sm-12">
                      <input type="text" class="form-control" id="edit-trigger-priority" placeholder="优先级（默认5）" >
                    </div>
                  </div>
                  <div class="form-group">
                    <div class="col-sm-12">
                      <input type="text" class="form-control" id="edit-trigger-description" placeholder="描述" >
                    </div>
                  </div>
              </form>
            ...
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" onclick="editTrigger()">Save Change</button>
          </div>
        </div>
      </div>
    </div>
</body>
</html>
